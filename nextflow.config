manifest {
    name            = 'clinical-vcf-pipeline'
    author          = 'Clinical Genomics Lab'
    description     = 'Clinical VCF annotation pipeline - Sequential annotations with Exomiser'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=21.04.0'
    version         = '1.1.0'
}

docker {
    enabled = true
    runOptions = '-v /home:/home -v /data:/data'
}

params {
    // Input/Output
    samplesheet    = null
    outdir         = './results'
    
    // Skip flags for optional databases
    skip_clinvar   = false  // ClinVar should work
    skip_hgmd      = true  // Requires license
    skip_dbnsfp    = true  // Large database (~30GB)
    skip_omim      = true   // Requires license
    skip_exomiser  = false  // Exomiser phenotype-driven analysis
    skip_tsv       = false  // Skip TSV extraction

    // Performance optimization
    split_dbnsfp_by_chr = true  // Split VCF by chromosome for parallel dbNSFP processing
    use_bcftools_split = true   // Use bcftools for splitting (more efficient than grep)
    
    // Chromosome processing
    chromosomes_to_process = "1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,X,Y,MT"
    skip_empty_chromosomes = true  // Skip chromosomes with no variants

    // Exomiser configuration
    exomiser_jar      = '/home/abudllah/exomiser-cli-14.0.0-distribution/exomiser-cli-14.0.0/exomiser-cli-14.0.0.jar'
    exomiser_data_dir = '/home/abudllah/exomiser-cli-14.0.0-distribution/exomiser-cli-14.0.0/data'
    exomiser_run_on   = 'raw'  // Options: 'raw' (original VCF) or 'annotated' (after all annotations)
    exomiser_fail_on_error = false  // If false, pipeline continues even if Exomiser fails
    
    // Resources
    max_memory     = '16.GB'
    max_cpus       = 4
    max_time       = '12.h'
    help           = false
}

// Include base configuration
includeConfig 'conf/base.config'
includeConfig 'conf/resources_grch37.config'

profiles {
    docker {
        docker.enabled = true
        process {
            // All annotation processes use the same container
            withName: 'SNPEFF_ANNOTATE|SNPSIFT_.*|GENERATE_REPORT' {
                container = 'staphb/snpeff:latest'
            }
            
            withName: 'PARSE_SAMPLESHEET' {
                container = 'quay.io/biocontainers/python:3.9--1'
            }
            
            // Exomiser runs locally, no container
            withName: 'EXOMISER_ANALYSIS' {
                container = null
                executor = 'local'
                errorStrategy = params.exomiser_fail_on_error ? 'terminate' : 'ignore'
            }
            
            // Chromosome splitting processes
            withName: 'SPLIT_VCF_BY_CHR' {
                container = params.use_bcftools_split ? 
                    'staphb/bcftools:1.22' : 
                    'staphb/snpeff:latest'
                cpus = 2
                memory = 4.GB
                time = 30.m
                errorStrategy = 'retry'
                maxRetries = 2
            }
            
            withName: 'SNPSIFT_DBNSFP_CHR' {
                container = 'staphb/snpeff:latest'
                cpus = 2
                memory = 8.GB
                time = 2.h
                maxForks = 6
                errorStrategy = 'retry'
                maxRetries = 2
            }
            
            //withName: 'MERGE_CHR_VCFS' {
            //    container = 'staphb/bcftools:1.22'
            //    cpus = 2
            //    memory = 4.GB
            //    time = 30.m
            //    errorStrategy = 'retry'
            //    maxRetries = 1
            //}
               withName: 'COMPRESS_VCFS' {
                    container = 'quay.io/biocontainers/samtools:1.14--hb421002_0'
                    }
   
                withName: 'MERGE_CHR_VCFS' {
                    container = 'staphb/bcftools:1.22'
                    }
            }
        }

    local {
        docker.enabled = false
    }
}

process.shell = ['/bin/bash', '-euo', 'pipefail']

def timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${timestamp}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${timestamp}.html"
}