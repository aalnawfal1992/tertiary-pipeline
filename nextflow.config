manifest {
    name            = 'clinical-vcf-pipeline'
    author          = 'Clinical Genomics Lab'
    description     = 'Clinical VCF annotation pipeline - Sequential annotations with Exomiser'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=21.04.0'
    version         = '1.1.0'
}

docker {
    enabled = true
    runOptions = '-v /home:/home -v /data:/data'
}

params {
    // Input/Output
    samplesheet    = null
    outdir         = './results'
    
    // Skip flags for optional databases
    skip_clinvar   = false  // ClinVar should work (you have it)
    skip_hgmd      = true   // Requires license
    skip_dbnsfp    = true   // Large database (~30GB)
    skip_omim      = true   // Requires license
    skip_exomiser  = false  // Exomiser phenotype-driven analysis
    skip_tsv       = false  // Skip TSV extraction
    
    // Exomiser configuration
    exomiser_jar      = '/home/abudllah/exomiser-cli-14.0.0-distribution/exomiser-cli-14.0.0/exomiser-cli-14.0.0.jar' // Chnage it to the local dir for exomiser
    exomiser_data_dir = '/home/abudllah/exomiser-cli-14.0.0-distribution/exomiser-cli-14.0.0/data'
    exomiser_run_on   = 'raw'  // Options: 'raw' (original VCF) or 'annotated' (after all annotations)
    exomiser_fail_on_error = false  // If false, pipeline continues even if Exomiser fails
    
    // Resources
    max_memory     = '16.GB'
    max_cpus       = 4
    max_time       = '12.h'
    help           = false
}

// Include base configuration
includeConfig 'conf/base.config'
includeConfig 'conf/resources_grch37.config'

profiles {
    docker {
        docker.enabled = true
        process {
            // All annotation processes use the same container
            withName: 'SNPEFF_ANNOTATE|SNPSIFT_.*|GENERATE_REPORT' {
                container = 'staphb/snpeff:latest'
            }
            withName: 'PARSE_SAMPLESHEET' {
                container = 'quay.io/biocontainers/python:3.9--1'
            }
            // Exomiser runs locally, no container
            withName: 'EXOMISER_ANALYSIS' {
                container = null
                executor = 'local'
                errorStrategy = params.exomiser_fail_on_error ? 'terminate' : 'ignore'
            }
        }
    }
    
    local {
        docker.enabled = false
    }
}

process.shell = ['/bin/bash', '-euo', 'pipefail']

def timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline_${timestamp}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report_${timestamp}.html"
}